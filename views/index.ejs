<!DOCTYPE HTML>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>餐库</title>
  <link href="/css/reset.css" rel="stylesheet" type="text/css" />
  <link href="/css/style.css" rel="stylesheet" type="text/css" />
  <script src="/js/jquery.js" type="text/javascript"></script>
  <!--[if IE]><script src="/static/js/html5.js"></script><![endif]-->
</head>
<body>
<!--[if lte IE 6]><div class="fuck-ie6">你妹啊，还用IE6？</div><![endif]-->
<nav class="nav">
  <div title="餐库" class="logo"><span>餐库</span></div>
  <ul>
    <li id="li_home" class="active"><a href="/">首页<span>关注的收藏夹，最新动态</span><i></i></a></li>
    <li id="li_shop"><a href="/shop">餐馆<span>全部的餐馆都在这里</span><i></i></a></li>
  </ul>
  <div class="line"></div>
</nav>
<section class="main clearfix">
  <div class="login-info">
    <% if (locals.session.user) { %>
    <span><%=locals.session.user.name%> &nbsp;/&nbsp;<a href="/order">我的历史订单</a>&nbsp;/&nbsp;<a href='/logout'>退出</a></span>
    <% } else { %>
    <span><a href='/register'>注册</a> |
    <a href='/login'>登录</a></span>
    <% } %>
  </div>
  <nav class="site-nav">
    <a href="/">餐库首页</a>
  </nav>
  <section class="wrap">
    <h1 class="page-title">今日已点订单</h1>
    <table id="today-list" class="today" cellpadding="0" cellspacing="0">
      <thead>
      <tr>
        <th class="name">用户名</th>
        <th class="food">订单内容</th>
        <th class="total">共计</th>
      </tr>
      </thead>
      <tbody>
      <% orders.forEach(function(order){%>
      <tr>
        <td class="name user-<%=order.user_id%>"><%=order.user_name%></td>
        <td class="food">
          <ul>
          <% order.order.forEach(function(food){ %>
          <li><%=food.name%> - <%=food.price%>元 - <%=food.num%> 份</li>
          <%})%>
          </ul>
        </td>
        <td class="total">
          ￥<%=order.total%>
        </td>
      </tr>
      <%})%>
      </tbody>
      <tfoot>
      <tr style="text-align: right;background: #f9f9f9;">
        <td colspan="3">
          共计 <b><%=num%></b> 份， <b><%=total%></b> 元
        </td>
      </tr>
      </tfoot>
    </table>
    <table class="today dian">
      <thead><tr><th>订餐统计清单</th></tr></thead>
      <tbody>
      <% for(key in dian){%>
      <tr><td><%=dian[key].name%> - <%=dian[key].num%>份</td></tr>
      <%}%>
      </tbody>
      <tfoot>
      <tr style="text-align: right;background: #f9f9f9;">
        <td colspan="3">
          共计 <b><%=num%></b> 份， <b><%=total%></b> 元
        </td>
      </tr>
      </tfoot>
    </table>
    <div class="clearfix" ></div>
    <h1 class="page-title" style="margin-top:20px;">猜猜谁点菜？</h1>
    <% if(canYao){%>
    <input type="button" class="btn" id="yao" value="开始摇起来！" />
    <%}else if(do_user_name){%>
    <p><%=do_user_name%>今天已经中奖了。</p>
    <%}else{%>
    <p>今天不是你摇奖！</p>
    <%}%>
  </section>
</section>
<script type="text/javascript">
  $(document).ready(function(){
    $('.user-<%=locals.session.user._id%>').parent().addClass('me');
    $('#yao').click(function(){
      var list = $("#today-list tbody tr td.name");
      if(list.length<=0){
        alert("还没有人订餐呀！");
      }else{
        var ra = randomToN(list.length);
        $.ajax({
          type: "POST",
          url: "/submit_caller",
          data: "name="+$(list[ra]).text(),
          dataType: 'json',
          success: function(data){
            if(data.result=="not-u"){
              alert('不是你摇奖哦！');
            }else if(data.result=="success"){
              alert($(list[ra]).text() +"中奖了");
            }else if(data.result=="ed"){
              alert("呃，好像有人摇过了。"+data.name+"已经中奖了！");
            }
          },
          error: function(){
          }
        });
      }
    });
  });

  function randomToN(maxVal, floatVal) {
    var randVal = Math.random() * maxVal;
    return typeof floatVal === 'undefined' ? Math.floor(randVal) : randVal.toFixed(floatVal);
  }
</script>
</body>
</html>